\chapter{Shape Manipulation of Bevel-tip Needles} \label{chap:chap-4}
% \begin{itemize}
% \item Model: ICRA 2024
% \item Control: EMBC 2024
% \item Feedback: (simulated) EMBC 2024
% \end{itemize}

\section{Chapter Overview}
\label{sec:chap-4-overview}

Needle base manipulation is a special case of manipulation where inputs act entirely on the needle base, and they follow the needle base as the needle inserts. Needle \textit{shape} manipulation is more general, during which inputs can be place anywhere along the needle, and might or might not follow the needle as it goes into soft tissues. This chapter extends the model in~\cref{chap:chap-3} such that generic control inputs can be placed anywhere along the length of the needle, and that shape manipulation can be effectively taken into account. In addition, we augment the previous simulation to take into account asymmetric needle tip designs, and explore how resolved-rate control can lead to unsafe shape manipulations for bevel-tip needles in the absence of a planned path.

\section{Modeling of Needle Shape Manipulation}
\label{sec:chap-4-model}

Bevel-tip needle insertions are often modeled using kinematic descriptions originating from the field of vehicle dynamics, where needle motions are formulated from a series of nonholonomic constraints~\parencite{parkDiffusionBasedMotionPlanning2005,websterNonholonomicModelingNeedle2006,alterovitzMotionPlanningUncertainty2008}. Although kinematic models can simplify needle path planning and shape prediction, their application is limited to cases where the needle is highly flexible relative to the surrounding soft tissues, and the interaction between needle shaft and soft tissues is negligible. Additionally, needle steering is typically restricted to insertion and axial rotation, while avoiding any lateral needle motion that can cause the flexible needle to bend due to soft tissue interactions, further limiting the overall generalizability of such approach.

One way to account for the interaction between the needle's shaft and soft tissue is through force modeling~\parencite{dimaioNeedleSteeringMotion2005,dimaioInteractiveSimulationNeedle2005,abolhassaniNeedleInsertionSoft2007,glozmanImageGuidedRoboticFlexible2007,abayazidIntegratingDeflectionModels2013,roesthuisMechanicsNeedleTissueInteraction,adagolodjoRoboticInsertionFlexible2019}. In planar cases, the lateral interaction between a flexible needle and soft tissue is typically represented by a linear elastic beam for the needle shaft, and distributed linear springs along the needle shaft for the tissue~\parencite{dimaioNeedleSteeringMotion2005,dimaioInteractiveSimulationNeedle2005,abolhassaniNeedleInsertionSoft2007,glozmanImageGuidedRoboticFlexible2007,abayazidIntegratingDeflectionModels2013}. For example, DiMaio and Salcudean~\parencite{dimaioNeedleSteeringMotion2005,dimaioInteractiveSimulationNeedle2005} present a mechanics-based model based on linear needle bending model coupled with a linear tissue material, and they use needle base control to guide a symmetric-tip needle to a desired location. Glozman and Shoham~\parencite{glozmanImageGuidedRoboticFlexible2007} use a distributed linear spring model to represent tissue reaction force, and their method relies on X-ray feedback to close the control loop. Roesthuis~\textit{et al.} extend the formulation to bevel tip needles by considering a transverse tip force generated by soft tissues during needle insertion~\cite{roesthuisMechanicsNeedleTissueInteraction}, and Abayazid~\textit{et al.} further enrich the formulation by considering the double-bend shape of a bevel-tip needle~\parencite{abayazidIntegratingDeflectionModels2013}. 

Notably, work done on symmetric-tip needles is primarily focused on lateral base motion to achieve needle steering; on the other hand, bevel-tip needle steering is typically achieved only by changing the bevel orientation via axial rotation, while largely ignoring lateral motion of the needle. However, in reality, both lateral base motion and needle tip bevel can be used for steering, albeit with different working principles. Furthermore, a common feature of previous works is the use of largely simplified linear tissue behavior model. Biological soft tissues exhibit highly nonlinear stress-stretch behavior, which cannot be captured by such models~\parencite{humphreyIntroductionBiomechanicsSolids2025,singhMechanicalPropertiesWholebody2021}. The lack of a realistic tissue model also makes the choice of tissue linearity measure rather arbitrary. Adagolodjo~\textit{et al.} address tissue nonlinearity in symmetric needle insertions using the SOFA framework~\parencite{adagolodjoRoboticInsertionFlexible2019}, an open-source interactive finite element physics simulator designed to provide real-time computational capabilities~\parencite{faureSOFAMultiModelFramework2012, coevoetSoftwareToolkitModeling2017}. However, no model validation is provided in~\parencite{adagolodjoRoboticInsertionFlexible2019}; instead, the overall control system is evaluated, with model errors compensated for using high-frequency non-rigid tissue registration enabled by six Flex13 cameras, which is an unrealistic requirement in clinical settings.

We present 1) a mechanics-based needle-tissue interaction model for bevel-tip needle insertion that accounts for nonlinear soft tissue behaviors and multi-layer scenarios, and 2) an interactive finite element simulation that allows full three-DOF planar control inputs to be placed anywhere along the needle, enabling the simulation of various clinical scenarios. We showcase the versatility of the model and simulation with soft tissue phantoms consisting of up to four different layers, as well as non-homogeneous chicken breast tissues.

\subsection{Modeling and Simulation}
\label{sec:chap-4-modeling-and-simulation}

Our goal is to create a prototypical mechanics-based bevel tip needle insertion simulation that accounts for 1) nonlinear strain-dependent behavior of biological soft tissues under compression, 2) needle interaction with multiple soft tissue layers of varied mechanical properties, 3) multiple control inputs along the length of the needle, and 4) full three-degree-of-freedom planar needle motions such as insertion, retraction, as well as bending and in-plane rotation.

The current simulation extends previous theoretical foundation~\parencite{wangFlexibleNeedleBending2023} with the introduction of bevel effect during needle insertion as well as incorporation of multiple control inputs along the length of the needle.

\begin{figure}[ht]
  \centering
  \includegraphics[width=\textwidth]{manuscripts/ICRA_2024/figures/model_schematic.png}
  \caption{Bevel tip needle insertion simulation with four layers of Ogden-type soft medium. Needle base controls horizontal ($H_1^m$) and vertical displacements and slope ($V_1^m$). A horizontally-fixed needle template (green circle) controls vertical displacement and prescribes zero slope ($V_2^m$). Contact points (blue cross) are placed dynamically, and simulate a bevel effect at the needle tip. Input steps $m\in \left\{ 1, 2, 3 \right\}$.}
  \label{fig:chap-4-model-schematic}
\end{figure}

To simulate the needle's bevel effect during insertion, an offset $b$ is applied to new contact points created at the needle tip (see~\cref{fig:chap-4-model-schematic}). This offset can correlate to the tip bevel geometry, and effectively creates a ``pre-stretched spring'' whose reaction force is tissue-dependent. By resolving the needle bending formulation in the next simulation step, the resultant tip force generated by the offset is computationally incorporated into the model, allowing the needle tip to bend in the corresponding direction. By controlling the sign and magnitude of this offset, different bevel effects can be simulated, as shown in~\cref{fig:chap-3-model-schematic}. Active needles whose tip orientation is adjustable can also be simulated by changing the offset parameter online, although such use cases are not considered in the current study~\parencite{ryuFeasibilityStudyOptically2011,karimi3DSteerableActive2019,padasdaoShapeMemoryAlloy2020}.

Known coordinates of the needle points can be used as control points along the needle, and are treated as essential boundary conditions for their corresponding node. For example, the needle base can have a known configuration that is robotically controlled, and the needle shaft can be constrained to move through a template.

To create an interactive simulation, we distinguish two types of user inputs: ``vertical'' $V$-input and ``horizontal'' $H$-input. $V$-input is a condition that directly affects the needle's shape, such as nodal lateral displacement or slope of a particular point on the needle, and is treated similarly to essential boundary conditions of the finite element solver. $H$-input pertains only to needle insertion and retraction, and this kinematic problem is solved independently from the beam-bending problem. 

As shown in Fig.~\ref{fig:chap-4-model-schematic}, the simulation is displayed in a world-fixed frame $\mathcal{W}$, while needle deformation is obtained in a dynamically formulated constraint frame $\mathcal{C}$. After initializing the needle shape ${}^{\mathcal{W}}N$ and soft tissue layers in $\mathcal{W}$, the simulation reads user inputs to update the needle configuration. When contact between the needle tip and tissue boundary is detected, the first contact point ${}^\mathcal{W}C^1 = [x_{tip}, y_{tip}, \theta_{tip}]^\top$ is placed at the needle tip, and two rigid-body transformations $\mathbf{T}_\mathcal{W}^\mathcal{C}$, $\mathbf{T}_\mathcal{C}^\mathcal{W}$ are defined, which are used to transform needle coordinates from frame $\mathcal{W}$ to $\mathcal{C}$ and vice versa. Within step $m$, after including $V_i^m$, the finite element solution is obtained in the $\mathcal{C}$ frame. The converged solution for the needle, ${}^\mathcal{C}N$, is then updated by $H_j^m$ to simulate needle insertion or retraction. A new contact point can be added with an offset $b$ such that in the next simulation iteration, the needle tip will experience a pulling force in the direction of the bevel, thus creating a bevel insertion effect. Updated needle shape and contact points are then transformed back to frame $\mathcal{W}$, where the simulation is visually updated. Dynamic formulation of contact points allows the needle to be inserted in any initial position and orientation. The simulation is written in MATLAB, and the workflow is shown in~\cref{alg:chap-4-workflow}.

\begin{algorithm}[!h]
\newcommand{\PW}{{}^{\mathcal{W}}}
\newcommand{\PC}{{}^{\mathcal{C}}}\newcommand{\WtoC}{\mathcal{W}\text{to}\mathcal{C}}
\newcommand{\CtoW}{\mathcal{C}\text{to}\mathcal{W}}
\newcommand{\algAnd}{$\,$ \textbf{and} $\,$}
\newcommand{\algOr}{$\,$ \textbf{or} $\,$}
\caption{Interactive bevel needle simulation} \label{alg:chap-4-workflow}
\begin{algorithmic}[1]
 \Ensure ENV set \Comment{tissue boundaries and needle properties}
  \State initialization, $\PW N, \PW C = \varnothing$ 
  \While {true}
    \State [$V_i^m$, $H_j^m$] $\Leftarrow$ \Call{get\_inputs}{} \Comment{See~\cref{fig:chap-4-model-schematic}}
    \If {$\PW C = \varnothing$ \algAnd $x_{tip} \in \Omega_1$}
      \State $\PW C^1 \Leftarrow [x_{tip}, y_{tip}, \theta_{tip}]^\top$
    \EndIf
    \State [$\mathbf{T}_\mathcal{W}^\mathcal{C}, \mathbf{T}_\mathcal{C}^\mathcal{W}$] $\in SE(2)\Leftarrow$ \Call{get\_tf}{$\PW C_1$}
    \State [$\PC N$, $\PC C$] $\Leftarrow$ \Call{apply\_tf}{$\PW N, \PW C, \mathbf{T}_\mathcal{W}^\mathcal{C}$}
      \While {$itr \leq itr_{max}$}
        \State $\PC N \Leftarrow$ \Call{FEM}{$\PC N$, ENV, $V_i^k$}
        \If {$converged$}
          \State break
        \EndIf
        \State $itr \Leftarrow itr + 1$
      \EndWhile
    \State [$\PC N^{\prime}, \PC C^{\prime} ]\Leftarrow$ \Call{insertion}{$\PC N$, $H_i^k$}
    \State $[\PW N, \PW C ]\Leftarrow$ \Call{apply\_tf}{$\PC N^{\prime}$, $\PC C^{\prime}$, $\mathbf{T}_\mathcal{C}^\mathcal{W}$}
  \EndWhile
\end{algorithmic}
\end{algorithm}


\subsection{Experiment Methods and Hardware Components}
\label{sec:chap-4-experiment-methods}

To demonstrate the model's ability to match results from physical needle insertion experiments, a set of custom-created multi-layer tissue phantoms with different mechanical properties and geometrical features are developed. These phantoms, in addition to chicken breast tissues, are used for bevel needle insertion experiments, as shown in~\cref{fig:chap-4-robot}. Through a cone-beam computed tomography (CT) machine (Loop-X, BrainLab, Germany), scans of the needle after each insertion are obtained for needle shape reconstruction and to tune the model's parameters. Details of each step are presented in the following subsections.
\begin{figure}[ht]
  \centering
  \includegraphics[width=\columnwidth]{manuscripts/ICRA_2024/figures/setup.png}
  \caption{Experiment setup used for validating the simulation.}
  \label{fig:chap-4-robot}
\end{figure}

\subsubsection{Tissue Phantoms}
\label{sec:chap-4-developed-phantoms}

A total of three different multi-layer phantoms are created, as shown in~\cref{fig:chap-4-phantoms}. All phantoms are made of plastisol with varied amounts of hardener added to modify their stiffness. Although other materials are shown to better mimic the mechanical behavior of human soft tissues~\parencite{tejo-oteroSoftTissueMimickingUsingHydrogels2022}, they are still homogeneous in nature, and do not offer substantial advantages to plastisol in the context of this study. 

\begin{figure}[t]
  \centering
  \includegraphics[width=\columnwidth]{manuscripts/ICRA_2024/figures/tissue_phantoms.png}
  \caption{Tissue phantoms used in our experiments, with hardener-to-plastisol volume ratios labeled on each layer.}
  \label{fig:chap-4-phantoms}
\end{figure}

We use two types of plastisol: PM242 Ultra Clear/Low Odor Medium Plastisol (Bait Plastics, USA) and Regular Plastic (M-F Manufacturing, USA), along with their corresponding hardeners. In its original form, liquid plastisol is white in color that turns translucent when heated to around 250 $^{\circ}$C. The mixture solidifies after cooling, and layering effect is achieved by sequentially casting heated mixtures atop a previously solidified layer. All phantoms are cast in $80\times80\times80$~mm$^3$ acrylic boxes to reduce boundary slippage. Resin dye is added to visually distinguish each layer and facilitate layer thickness measurements.

Phantom 1 consists of four layers of varied thicknesses and mechanical properties and is developed for testing an insertion scenario with simple 2D geometry. Phantoms 2 and 3 are designed with the clinical context of prostate biopsies in consideration. Their first layer represents the different fat and muscle tissues encountered by the needle at the perineum entry point. Their second layer represents the diaphragm, which is known to be responsible for substantial needle deflection during biopsy. Their third layer represents the remaining soft tissues separating the diaphragm from the prostate, and their fourth ``layer'' is the prostate itself, represented here as a cylinder. The relative stiffness of aforementioned layers is chosen to qualitatively mimic the relative stiffness of equivalent organs in human anatomy \parencite{boubakerFiniteElementSimulation2009}.

\subsubsection{Hardware Setup}
\label{sec:chap-4-hardware-setup}

An 18 gauge, 15 cm long, notched biopsy needle (Cook Medical, USA) is employed for all experiments. To ensure a controlled needle insertion, a two-stage setup is used, as shown in~\cref{fig:chap-4-robot}. The needle is rigidly affixed to an XY linear stage (XY-6060, Danaher Precision Systems, USA), which is used to advance the needle forward and laterally. A Z linear stage (Model 12-1532, Dover Motion, USA) is used for adjusting the phantoms' vertical position to vary the type of tissue layers the needle can traverse and their effective thickness. The stages are secured on an acrylic plate, which also allows the positioning of the Z-stage at different angles. 

In order to avoid optical distortions caused by the simulant material, CT scans with a voxel size of $0.46\times0.46\times0.46$~mm$^{3}$ are used to extract the needle's shape after each insertion, as well as the effective insertion depth. Intensity thresholding is applied to the acquired images to segment the needle in 3D; radiopaque markers are used to transform the reconstructed needle to the world-fixed frame $\mathcal{W}$ using the Iterative Closest Point algorithm. Knowing the relative position of the reconstructed needle with respect to the tissue phantom and the thickness of each layer of the phantom, the effective distance traversed by the needle on the bevel bending plane is calculated and used to reconstruct the tissue boundaries in our planar simulation.

\subsection{Parameter Tuning}
\label{sec:chap-4-parameter-tuning}
Due to the physical nature of the proposed model, parameters need to be tuned to align the simulation to the empirical data. We consider tuning for constraint offset $b$, as well as material shear modulus $\mu$ and Ogden nonlinearity constant $\alpha$ for each layer, although the latter can be obtained via mechanical testing~\parencite{singhMechanicalPropertiesWholebody2021}.

Tuning experiments aim to examine the following aspects: 
\begin{itemize}
\item Model validity across different numbers of layers traversed by the needle.
\item Model validity across different tissue phantoms, as well as heterogeneous animal tissues.
\end{itemize}

For the first aspect, Phantom 2 is selected for conducting multiple insertions at various depths involving variations in insertion position and orientation. This approach effectively yields needle insertions spanning distinct layer counts and different layer thicknesses within the same phantom. For the second aspect, all three phantoms are used for carrying out additional insertions at various depths, as well as experiments on 3 chicken breasts. One of the chicken breasts is punctured at 2 different orientations, resulting in a total of $3\times4 = 12$ insertions. Model parameters are manually tuned for each phantom. The media used, traversed layers, number of insertions, and depth range are reported in~\cref{tab:chap-4-layers}.

Both needle tip and needle shape prediction accuracies are taken into consideration during parameter tuning, and the following metrics are used to evaluate the outcome:
\begin{itemize}
\item \textbf{Tip Error (TE):} needle tip location error compared to the ground truth
\begin{equation} \label{eq:chap-4-eq7}
TE = ||\boldsymbol{r}^K_{sim} - \boldsymbol{r}^K_{CT}||_2
\end{equation}
\item \textbf{In-Plane Error (IPE):} shape error at each point $j$ of the needle in the natural bending plane of the bevel tip
\begin{equation} \label{eq:chap-4-eq8}
IPE_j = ||\boldsymbol{r}^j_{sim} - \boldsymbol{r}^j_{CT} ||_2
\end{equation}
\item \textbf{Error-to-Deflection Percentage (EDP):} the percentage ratio of the tip error computed in~\cref{eq:chap-4-eq7} to the needle's tip deflection extracted from CT data
\begin{equation}
EDP = \frac{TE}{|{}^{\mathcal{W}}N^K_y - {}^{\mathcal{W}}N^1_y|} \times 100
\end{equation}
\end{itemize}
where $\boldsymbol{r} = [{}^{\mathcal{W}}N^1_x,  {}^{\mathcal{W}}N^1_y,..., {}^{\mathcal{W}}N^K_x, {}^{\mathcal{W}}N^K_y]^\top$ with $K$ being the total number of discretized needle points from the CT ground truth, and $\boldsymbol{r}^j = [{}^{\mathcal{W}}N^j_x,  {}^{\mathcal{W}}N^j_y]^\top$. The EDP metric enhances the understanding of the model's predictive accuracy by contextualizing the results of~\cref{eq:chap-4-eq7,eq:chap-4-eq8} with respect to different deflection magnitudes.

\begin{table}[h]
  \centering
\caption{Summary of needle insertion experiments.}
\label{tab:chap-4-layers}
\resizebox{0.8\columnwidth}{!}{%
  \begin{tabular}{|l|c|c|c|}
\hline
\multicolumn{1}{|c|}{\textbf{Medium}}     & \textbf{Layers} & \textbf{Insertions} & \textbf{Depth Range [mm]} \\ \hline
\multicolumn{1}{|c|}{\textbf{Phantom 1}}  & 3                   & 10                      & 50.69 - 54.27                   \\ \hline
\multirow{4}{*}{\textbf{Phantom 2}}       & 4                   & 9                       & 49.09 - 56.49                   \\ \cline{2-4} 
  & 3                   & 5                       & 33.60 - 54.78                   \\ \cline{2-4} 
  & 2                   & 1                       & 23.79                   \\ \cline{2-4} 
  & 1                   & 1                       & 19.63                  \\ \hline
\multicolumn{1}{|c|}{\textbf{Phantom 3}}  & 4                   & 9                       & 37.68 - 55.32                   \\ \hline
\multicolumn{1}{|c|}{\textbf{Chicken}}    & 1                   & 12                       & 26.98 - 61.22                   \\ \hline
\end{tabular}%
}
\end{table}

To examine the model's generalizability, a series of cross-validation studies are performed (see~\cref{tab:chap-4-cross-validation}). These studies aim to resolve the impact of distinct experiment features on the quality of the simulation results.

In Study 1, we use parameters tuned on Phantom 2 with insertions across four layers and examine insertion accuracy within the same phantom but across a reduced number of layers (see~\cref{sec:chap-4-parameter-tuning} for list of parameters). Although the constituents within the same phantom stay the same, the thickness of the traversed layers varies with different insertions. This validation study provides insight into how effectively the model can capture the mechanical properties of different layers, and its ability to transition from complex scenarios to simpler ones. In Study 2, the opposite is performed, \textit{i.e.} we use parameters tuned for two-layer insertions and extend the simulation to a more complex scenario (three and four layers); this study attempts to explain how well the model can transition from a simple scenario (2 layers) to a more complex one (3 and 4 layers) by introducing additional layers with known mechanical properties from the tuned model since the bottom 2 layers in Phantom 2 should have the same mechanical properties as the top 2 ones, as shown in~\cref{fig:chap-4-phantoms}.

\begin{table}[h]
  \centering
\caption{Summary of experiments used for model tuning with corresponding validation studies.}
\label{tab:chap-4-cross-validation}
\resizebox{0.85\columnwidth}{!}{%
\begin{tabular}{c|ccc|ccc|}
\cline{2-7}
  & \multicolumn{3}{c|}{\textbf{Model Tuning}}                                                                       & \multicolumn{3}{c|}{\textbf{Model Validation}}                                                                \\ \hline
\multicolumn{1}{|c|}{\textbf{Study}}              & \multicolumn{1}{c|}{\textbf{Media}}             & \multicolumn{1}{c|}{\textbf{Layers}}    & \textbf{Insertions} & \multicolumn{1}{c|}{\textbf{Media}}             & \multicolumn{1}{c|}{\textbf{Layers}} & \textbf{Insertions} \\ \hline
\multicolumn{1}{|c|}{\multirow{3}{*}{\textbf{1}}} & \multicolumn{1}{c|}{\multirow{3}{*}{Phantom 2}} & \multicolumn{1}{c|}{\multirow{3}{*}{4}} & \multirow{3}{*}{9}   & \multicolumn{1}{c|}{\multirow{3}{*}{Phantom 2}} & \multicolumn{1}{c|}{3}               & 5                    \\ \cline{6-7} 
\multicolumn{1}{|c|}{}                            & \multicolumn{1}{c|}{}                           & \multicolumn{1}{c|}{}                   &                      & \multicolumn{1}{c|}{}                           & \multicolumn{1}{c|}{2}               & 1                    \\ \cline{6-7} 
\multicolumn{1}{|c|}{}                            & \multicolumn{1}{c|}{}                           & \multicolumn{1}{c|}{}                   &                      & \multicolumn{1}{c|}{}                           & \multicolumn{1}{c|}{1}               & 1                    \\ \hline
\multicolumn{1}{|c|}{\multirow{2}{*}{\textbf{2}}} & \multicolumn{1}{c|}{\multirow{2}{*}{Phantom 2}} & \multicolumn{1}{c|}{\multirow{2}{*}{2}} & \multirow{2}{*}{1}   & \multicolumn{1}{c|}{\multirow{2}{*}{Phantom 2}} & \multicolumn{1}{c|}{4}               & 8                    \\ \cline{6-7} 
\multicolumn{1}{|c|}{}                            & \multicolumn{1}{c|}{}                           & \multicolumn{1}{c|}{}                   &                      & \multicolumn{1}{c|}{}                           & \multicolumn{1}{c|}{3}               & 6                    \\ \hline
\multicolumn{1}{|c|}{\textbf{3}}                  & \multicolumn{1}{c|}{Phantom 2}                  & \multicolumn{1}{c|}{3}                  & 1                    & \multicolumn{1}{c|}{Phantom 1}                  & \multicolumn{1}{c|}{3}               & 10                   \\ \hline
\multicolumn{1}{|c|}{\textbf{4}}                  & \multicolumn{1}{c|}{Phantom 2}                  & \multicolumn{1}{c|}{4}                  & 8                    & \multicolumn{1}{c|}{Phantom 3}                  & \multicolumn{1}{c|}{4}               & 9                    \\ \hline
\multicolumn{1}{|c|}{\textbf{5}}                  & \multicolumn{1}{c|}{Chicken}                    & \multicolumn{1}{c|}{1}                  & 3                    & \multicolumn{1}{c|}{Chicken}                    & \multicolumn{1}{c|}{1}               & 9                    \\ \hline
\end{tabular}%
}
\end{table}

Studies 3 and 4 examine the model's capability to generalize to different phantoms. In Study 3, the model is tuned on insertions across three layers in Phantom 2, but validated on insertions across three layers in Phantom 1. The two phantoms are known to have different mechanical properties by design. As for Study 4, we use Phantoms 2 and 3 for tuning and validation, respectively, whereby the two phantoms are designed to be similar in terms of geometrical features as well as mechanical properties, with a total of four traversed layers by the needle.

Study 5 is designed to test the model's ability to adapt to non-homogeneous animal tissues such as chicken breasts. Data collected on the first chicken breast (3 insertions) is selected for parameter tuning, and the tuned model is then tested against the remaining insertion experiments on the two other chicken breasts.

\subsection{Results and Discussion}
\label{sec:chap-4-results-and-discussion}

The results of the needle insertion experiments for the parameters' tuning are illustrated in~\cref{tab:chap-4-results}. The needle's Young's Modulus $E$ is set to be 80 GPa, and the simulation runs steadily with 1mm elements at about 80 Hz on an Intel Core i7-9750H CPU. Tissue parameters are adjusted proportionally to reflect the relative mechanical properties of the phantom's distinct layers.

The numerical values for the model's parameters for all experiments are reported in~\cref{tab:chap-4-params}. Registration error for the needle reconstruction is found to be on average 0.19 mm. Voxel size combined with said registration error could contribute to observed discrepancies between real and simulated results.

\begin{table}[h]
  \centering
\caption{Error statistics using the tuned models across different experiments. Units in mm except for EDP.}
\label{tab:chap-4-results}
\resizebox{0.8\columnwidth}{!}{%
\begin{tabular}{cc|cccc|}
\cline{3-6}
\multicolumn{1}{l}{} &  & \multicolumn{4}{c|}{\textbf{Average Values}} \\ \hline
\multicolumn{1}{|c|}{\textbf{Layers}} & \textbf{Median Err} & \multicolumn{1}{c|}{\textbf{IPE}} & \multicolumn{1}{c|}{\textbf{Max IPE}} & \multicolumn{1}{c|}{\textbf{TE}} & \textbf{EDP} \\ \hline
\multicolumn{1}{|c|}{\textbf{4}} & 0.18 & \multicolumn{1}{c|}{0.23$\pm$0.17} & \multicolumn{1}{c|}{0.62} & \multicolumn{1}{c|}{0.44} & 10.3 \\ \hline
\multicolumn{1}{|c|}{\textbf{3}} & \textbf{0.16} & \multicolumn{1}{c|}{\textbf{0.18$\pm$0.13}} & \multicolumn{1}{c|}{\textbf{0.49}} & \multicolumn{1}{c|}{\textbf{0.16}} & \textbf{4.77} \\ \hline
\multicolumn{1}{|c|}{\textbf{2}} & 0.18 & \multicolumn{1}{c|}{0.20$\pm$0.14} & \multicolumn{1}{c|}{0.53} & \multicolumn{1}{c|}{0.53} & 58.1 \\ \hline
\multicolumn{1}{|c|}{\textbf{1}} & 0.36 & \multicolumn{1}{c|}{0.36$\pm$0.14} & \multicolumn{1}{c|}{0.60} & \multicolumn{1}{c|}{0.57} & 135 \\ \hline
\textbf{} & \textbf{} & \multicolumn{4}{c|}{\textbf{}} \\ \hline
\multicolumn{1}{|c|}{\textbf{Media}} & \textbf{Median Err} & \multicolumn{1}{c|}{\textbf{IPE}} & \multicolumn{1}{c|}{\textbf{Max IPE}} & \multicolumn{1}{c|}{\textbf{TE}} & \textbf{EDP} \\ \hline
\multicolumn{1}{|c|}{\textbf{Phantom 1}} & 0.21 & \multicolumn{1}{c|}{0.24$\pm$0.18} & \multicolumn{1}{c|}{0.56} & \multicolumn{1}{c|}{0.29} & 26.6 \\ \hline
\multicolumn{1}{|c|}{\textbf{Phantom 2}} & \textbf{0.17} & \multicolumn{1}{c|}{\textbf{0.21$\pm$0.16}} & \multicolumn{1}{c|}{0.57} & \multicolumn{1}{c|}{0.37} & 19.4 \\ \hline
\multicolumn{1}{|c|}{\textbf{Phantom 3}} & 0.22 & \multicolumn{1}{c|}{0.26$\pm$0.19} & \multicolumn{1}{c|}{0.60} & \multicolumn{1}{c|}{\textbf{0.18}} & \textbf{16.5} \\ \hline
\multicolumn{1}{|c|}{\textbf{Chicken}} & 0.22 & \multicolumn{1}{c|}{0.27$\pm$0.18} & \multicolumn{1}{c|}{\textbf{0.54}} & \multicolumn{1}{c|}{0.35} & 76.9 \\ \hline
\end{tabular}%
}
\end{table}

From~\cref{tab:chap-4-results}, the median as well as average IPE errors across all four layers in Phantom 2 are within 0.37 mm. The largest average IPE error per insertion is 0.62 mm for the four-layer insertion, and the largest average TE observed for the one-layer insertion is 0.57 mm. The EDP values for deeper insertions are smaller than those for shallower insertions, which is expected since shallower insertions (such as the case for a one-layer insertion) result in smaller needle deflection -- an error as small as 0.3 mm can translate to a relatively large EDP if the needle deflection is below 0.5 mm. Keeping in mind clinical applications for biopsy needle insertions, a submillimeter accuracy would be acceptable nonetheless, in particular for prostate biopsies with average insertion depths of 80 mm~\parencite{moreiraEvaluationRobotAssistedMRIGuided2018}. The results demonstrate that the simulation can successfully and consistently match physical experiments across various number of layers.

To assess the simulation performance across various phantoms, we tuned the model parameters for each media to align the simulation outcomes with experiment data. These findings are detailed in~\cref{tab:chap-4-results}. Both median and average errors do not exceed 0.27 mm, with a maximum average IPE of 0.60 mm observed for Phantom 3. The average needle TE is also smaller than 0.36 mm, with small EDP percentages across all tested phantoms. The model is able to match the data collected from the heterogeneous chicken tissues without degradation in performance. The large EDP value for the chicken experiments is a result of the small observed needle deflection from the CT scans due to shallower needle insertions. The results show that the model is capable of simulating different insertions into the same media, irrespective of the number of layers and their corresponding thickness. 

\begin{table}[]
  \centering
\caption{Results of the different model validation studies. Units in mm except for EDP.}
\label{tab:chap-4-validation}
\resizebox{0.8\columnwidth}{!}{%
\begin{tabular}{ccc|cccc|}
\cline{4-7}
\multicolumn{1}{l}{} & \multicolumn{1}{l}{} &  & \multicolumn{4}{c|}{\textbf{Average Values}} \\ \hline
\multicolumn{1}{|c|}{\textbf{Study}} & \multicolumn{1}{l|}{\textbf{Layers}} & \textbf{Median Err} & \multicolumn{1}{c|}{\textbf{IPE}} & \multicolumn{1}{c|}{\textbf{Max IPE}} & \multicolumn{1}{c|}{\textbf{TE}} & \textbf{EDP} \\ \hline
\multicolumn{1}{|c|}{\multirow{3}{*}{\textbf{1}}} & \multicolumn{1}{c|}{\textbf{3}} & 0.17 & \multicolumn{1}{c|}{0.19$\pm$0.13} & \multicolumn{1}{c|}{0.54} & \multicolumn{1}{c|}{0.14} & 5.56 \\ \cline{2-7} 
\multicolumn{1}{|c|}{} & \multicolumn{1}{c|}{\textbf{2}} & 0.20 & \multicolumn{1}{c|}{0.22$\pm$0.15} & \multicolumn{1}{c|}{0.59} & \multicolumn{1}{c|}{0.59} & 64.8 \\ \cline{2-7} 
\multicolumn{1}{|c|}{} & \multicolumn{1}{c|}{\textbf{1}} & 0.39 & \multicolumn{1}{c|}{0.39$\pm$0.15} & \multicolumn{1}{c|}{0.64} & \multicolumn{1}{c|}{0.64} & 151 \\ \hline
\multicolumn{1}{|c|}{\multirow{2}{*}{\textbf{2}}} & \multicolumn{1}{c|}{\textbf{4}} & 0.24 & \multicolumn{1}{c|}{0.28$\pm$0.22} & \multicolumn{1}{c|}{0.77} & \multicolumn{1}{c|}{0.50} & 11.7 \\ \cline{2-7} 
\multicolumn{1}{|c|}{} & \multicolumn{1}{c|}{\textbf{3}} & 0.19 & \multicolumn{1}{c|}{0.24$\pm$0.19} & \multicolumn{1}{c|}{0.62} & \multicolumn{1}{c|}{0.43} & 12.0 \\ \hline
\multicolumn{1}{|c|}{\textbf{3}} & \multicolumn{1}{c|}{\textbf{3}} & 1.41 & \multicolumn{1}{c|}{1.41$\pm$0.83} & \multicolumn{1}{c|}{2.86} & \multicolumn{1}{c|}{2.82} & 254 \\ \hline
\multicolumn{1}{|c|}{\textbf{4}} & \multicolumn{1}{c|}{\textbf{4}} & 1.09 & \multicolumn{1}{c|}{1.18$\pm$0.68} & \multicolumn{1}{c|}{2.48} & \multicolumn{1}{c|}{2.19} & 201 \\ \hline
\multicolumn{1}{|c|}{\textbf{5}} & \multicolumn{1}{c|}{\textbf{1}} & 0.58 & \multicolumn{1}{c|}{0.46$\pm$0.25} & \multicolumn{1}{c|}{0.85} & \multicolumn{1}{c|}{0.60} & 500 \\ \hline
\end{tabular}%
}
\end{table}

The results for the model validation studies are reported in~\cref{tab:chap-4-validation} and~\cref{fig:chap-4-valid}, with corresponding model parameters in~\cref{tab:chap-4-params}. In both Studies 1 and 2, the largest median and average IPE errors are below 0.39 mm, with the largest average maximum IPE per insertion being 0.77 mm, and largest average tip error 0.59 mm. This shows that the model can be tuned on both complex ($>2$ layers) and simpler (2 layers in this case) models, without loss of generalizability when transitioning to different insertions within the same medium. It is important to highlight the clinical benefit of such observations, whereby only a handful of insertions into a patient could be used to reasonably predict the needle shape and deflection for different insertions with the same patient.

In Studies 3 and 4, the overall errors are larger compared to Studies 1 and 2, with the largest average maximum IPE reaching 2.86 mm in Study 3. The results do, however, align with our expectations. Phantom 1 is inherently different from Phantom 2 in terms of mechanical properties, so parameter values identified for a model that fits Phantom 2 are unlikely to immediately translate to a different phantom. Similarly, although Phantom 3 is designed to replicate Phantom 2, it is created by two different people at different times, which implies that some differences between the two will still be observed. In a real scenario, these differences represent patient-to-patient variability, and underscore the futility of seeking a ``one-fits-all'' solution that will seamlessly work for all patients without modification.

\begin{figure}[h]
  \centering
  \includegraphics[width=\columnwidth]{manuscripts/ICRA_2024/figures/boxplot_validation.png}
  \caption{Boxplots for all conducted validation studies.}
  \label{fig:chap-4-valid}
\end{figure}

The submillimeter errors reported in Study 5 highlight the model's potential to reasonably capture complex heterogeneous tissue-needle interactions. \Cref{fig:chap-4-valid} demonstrates the model's capability to generalize within the same medium and across heterogeneous tissues, but not so much across different types of phantoms.

The large EDP values in~\cref{tab:chap-4-validation} (>100\%) across all studies are attributed to the smaller needle deflections (0.02-1.5 mm) due to shallower insertions, as well as the smaller amount of data available for analysis in certain cases, such as in Study 1 for the two and one-layer insertions.

 It is important to note the limitations of the study. First, the parameters are manually tuned, which means that a more robust optimization strategy will likely lead to even better results. Second, some studies only had one needle insertion experiment (Phantom 2 with two-layer and one-layer insertions), which could skew some of the reported results. Lastly, the realism of the phantoms compared to human tissues needs to be further validated.  


 \begin{table}[h]
   \centering
\caption{Model parameters tuned for each set of experiments. Ph: Phantom, Ch: Chicken, T: Table, St: Study.}
\label{tab:chap-4-params}
\resizebox{0.8\columnwidth}{!}{%
\begin{tabular}{l|cc|cc|cc|cc|c|}
\cline{2-10}
\multicolumn{1}{c|}{}                     & \multicolumn{2}{c|}{\textbf{Layer 1}}                   & \multicolumn{2}{c|}{\textbf{Layer 2}}                   & \multicolumn{2}{c|}{\textbf{Layer 3}}                   & \multicolumn{2}{c|}{\textbf{Layer 4}}                   & \textbf{Bevel} \\ \cline{2-10} 
\multicolumn{1}{c|}{}                     & \multicolumn{1}{c|}{\textbf{$\mu$}} & \textbf{$\alpha$} & \multicolumn{1}{c|}{\textbf{$\mu$}} & \textbf{$\alpha$} & \multicolumn{1}{c|}{\textbf{$\mu$}} & \textbf{$\alpha$} & \multicolumn{1}{c|}{\textbf{$\mu$}} & \textbf{$\alpha$} & \textbf{$b$}   \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph2 T4}}     & \multicolumn{1}{c|}{2e5}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & \multicolumn{1}{c|}{2e5}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & 0.085          \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph1 T5}}     & \multicolumn{1}{c|}{2e5}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & \multicolumn{1}{c|}{2e6}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & 0.03           \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph2 T5}}     & \multicolumn{1}{c|}{2e5}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & \multicolumn{1}{c|}{2e5}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & 0.085          \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph3 T5}}     & \multicolumn{1}{c|}{2e5}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & \multicolumn{1}{c|}{2e5}            & 1                 & \multicolumn{1}{c|}{3.3e7}          & -1                & 0.03           \\ \hline
\multicolumn{1}{|l|}{\textbf{Ch T5}}      & \multicolumn{1}{c|}{1e3}            & 1                 & \multicolumn{1}{c|}{n/a}            & n/a               & \multicolumn{1}{c|}{n/a}            & n/a               & \multicolumn{1}{c|}{n/a}            & n/a               & 0.085          \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph2 T6 St1}} & \multicolumn{1}{c|}{2.2e5}          & 1                 & \multicolumn{1}{c|}{3.2e7}          & -1                & \multicolumn{1}{c|}{2.2e5}          & 1                 & \multicolumn{1}{c|}{3.2e7}          & -1                & 0.085          \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph2 T6 St2}} & \multicolumn{1}{c|}{5e4}            & 1                 & \multicolumn{1}{c|}{1e7}            & -1                & \multicolumn{1}{c|}{5e4}            & 1                 & \multicolumn{1}{c|}{1e7}            & -1                & 0.085          \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph2 T6 St3}} & \multicolumn{1}{c|}{2.2e5}          & 0.85              & \multicolumn{1}{c|}{3.2e7}          & -0.98             & \multicolumn{1}{c|}{2.2e5}          & 0.85              & \multicolumn{1}{c|}{3.2e7}          & -0.98             & 0.085          \\ \hline
\multicolumn{1}{|l|}{\textbf{Ph2 T6 St4}} & \multicolumn{1}{c|}{2.2e5}          & 1                 & \multicolumn{1}{c|}{3.2e7}          & -1                & \multicolumn{1}{c|}{2.2e5}          & 1                 & \multicolumn{1}{c|}{3.2e7}          & -1                & 0.085          \\ \hline
\multicolumn{1}{|l|}{\textbf{Ch T6 St5}}  & \multicolumn{1}{c|}{4e3}            & 0.2               & \multicolumn{1}{c|}{n/a}            & n/a               & \multicolumn{1}{c|}{n/a}            & n/a               & \multicolumn{1}{c|}{n/a}            & n/a               & 0.085          \\ \hline
\end{tabular}%
}
\end{table}

\section{Simulated Resovled-Rate Control with Tip State Feedback}
\label{sec:chap-4-control}

Mechanics-based models in needle shape prediction still face accuracy limitations due to their dependency on mechanical and geometrical properties of the needle and tissues. This issue can be mitigated by introducing closed-loop controls that use feedback to compensate for modeling inaccuracies. For instance, Khadem \textit{et al.}~\parencite{khademUltrasoundGuidedModelPredictive2016} developed a nonlinear model predictive needle controller integrated with US-based needle tip position feedback, achieving a maximum targeting error of 2.85mm in tissue steering experiments, albeit only by controlling the needle's axial rotation. With the increased usage of transperineal biopsy templates~\parencite{abdulmajedRoleTransperinealTemplate2015}, omitting lateral needle movement limits the clinical translation of such approach. Lehmann \textit{et al.}~\parencite{lehmannDeflectionModelingNeedle2017} developed a semi-autonomous needle insertion platform for US-guided prostate brachytherapy, modeling a point force application to an inserted bevel-tip needle for control using beam mechanics. The authors validated their model using US tracking and force measurements with an average targeting error of roughly 2 mm for a 140 mm needle insertion depth. However, neither studies~\parencite{lehmannDeflectionModelingNeedle2017,khademUltrasoundGuidedModelPredictive2016} evaluate the methods' effectiveness when model parameters do not precisely match the physical setup, as is often the case in practice.

\begin{figure}[t]
  \centering
  \includegraphics[width=\columnwidth]{manuscripts/EMBC_2024/figures/schematic.png}
  \caption{Schematic of bevel-tip needle insertion into multi-layered soft tissues. The global frame is placed at needle entry point on skin surface. Needle base translates along the $x$- and $y$-axis with a fixed slope; the needle template moves independently along the $y$-axis with an unconstrained slope. Bevel effect can be achieved by placing contact points (blue crosses) to drive the needle tip in the direction of the bevel ($-y$ in this case). Final needle shape is achieved through a sequence of base and template motions \textcircled{1} through \textcircled{3}.}
  \label{fig:chap-4-schematic}
\end{figure}

Data-driven strategies can present as an alternative to modeling. For example, utilizing Broyden's method, Bernardes \textit{et al.}~\parencite{bernardesDataDrivenAdaptiveNeedle2023} used a bevel-tip needle with an embedded electromagnetic tracking sensor for collaborative, robot-assisted prostate biopsies with a needle-guiding stage. By updating the mapping between actuator inputs and observed changes in needle tip position, the authors were able to achieve targeting accuracy of less than 1mm in \textit{ex vivo} tissue.

Here, we formulate the mechanics of local needle shape changes along the needle shaft when interacting with nonlinear soft tissues, and examine the effect of shape manipulation on a bevel-tip needle's trajectory within a simulated environment. Specifically, we compare two resolved-rate controllers whose local system dynamics are derived numerically via either a data-driven or a mechanics-based method. We demonstrate that the mechanics-based controller can better reach desired targets when only the final goal configuration is presented even with uncertainty on model parameters estimation, and that providing a feasible needle path is crucial in ensuring safe surgical outcomes when either controller is used for needle shape manipulation.

In the insertion example shown in~\cref{fig:chap-4-schematic}, the needle first passes through a template before reaching soft tissues. Inputs to the needle are placed at the needle base and needle template. The needle base is modeled as a fixed support at each time step and is allowed to translate along the $x$- and $y$-axis, while the needle template acts as a roller support and only moves along the $y$-axis. Such physical constraints are enforced as essential boundary conditions in the finite element solver, and can be modified depending on the specific hardware setup. By coupling needle base and template motions with bevel-tip insertion behavior, needle shape with multi-step inputs can be simulated.

\subsection{Resolved-Rate Controllers for Shape Manipulation}
\label{sec:chap-4-resolved-rate-controllers}
A resolved-rate controller relies on a system dynamics that relates input and output velocities with a Jacobian, $\mathbf{J}$:
\begin{equation}
\dot{\mathbf{y}} = \mathbf{J}(\mathbf{x})\dot{\mathbf{x}}.\label{eq:chap-4-resolved-rate-dynamics}
\end{equation}
For tracking and regulation, the following discretized control law can be used:
\begin{equation}
  \Delta \mathbf{x}^{[n]} = -\left(\mathbf{J}^{[n]}\right)^{-1}\mathbf{K_p}(\mathbf{y}^{[n]} - \mathbf{y_d}^{[n]}), \label{eq:chap-4-control-law}
\end{equation}
where $\Delta\mathbf{x}$ is the control input, $\mathbf{K_p}$ is a proportional gain matrix, and $\mathbf{y_d}$ is the desired output. Superscript $n$ denotes the $n^\text{th}$ time step. This control law necessitates updates and the inversion of the Jacobian matrix, under the assumption that $\left(\mathbf{J}^{[n]}\right)^{-1}$ exists.

In the present case, the positions of needle base and template are the three control inputs to the system, \textit{i.e.} $\mathbf{x} = [x_{base}, y_{base}, y_{template}]^{\top}$, and the needle tip position and slope as three system outputs, \textit{i.e.} $\mathbf{y} = [x_{tip}, y_{tip}, k_{tip}]^{\top}$ .

The goal is to obtain a mapping $\mathbf{J}$ between the three input-output sets to implement a resolved-rate control law. Here, we describe two methods of obtaining and updating $\mathbf{J}$ -- a data-driven method and a mechanics-based method.


\subsubsection{Data-driven Method}
\label{sec:chap-4-data-driven-control}
A data-driven approach relies on an update law to obtain and update the Jacobian matrix. Using Broyden's method, the Jacobian matrix can be iteratively approximated based on the following rule:
\begin{equation}
  \mathbf{J}^{[n]} = \mathbf{J}^{[n - 1]} + \frac{\mathbf{\Delta y}^{[n]} - \mathbf{J}^{[n - 1]}\Delta \mathbf{x}^{[n]}}{\Vert \Delta \mathbf{x}^{[n]}\Vert ^2} \left(\Delta \mathbf{x}^{[n]}\right)^{\top}. \label{eq:chap-4-update-law}
\end{equation}
where $\Delta \mathbf{y}^{[n]} = \mathbf{y}^{[n]} - \mathbf{y}^{[n - 1]}$ is the difference in function value at the current and previous iterations, and $\Delta \mathbf{x}^{[n]}$ is the difference in function arguments at the current and previous iteration. 

\subsubsection{Finite Difference Method}
\label{sec:chap-4-finite-difference-control}
A mechanics-based approach relies on a physical model or simulation of a model. In the case of a bevel-tip needle insertion through a movable template, by completing~\cref{alg:chap-4-workflow}, the input-output system can be written as
\begin{equation}
\mathbf{y} = \mathbf{f}(\mathbf{x}),
\end{equation}
where $\mathbf{x} \in \mathcal{R}^N$ denotes the input to the solver, such as a prescribed nodal displacement, and $\mathbf{y} \in \mathcal{R}^M$ denotes the output, such as nodal position and orientation.

Instead of an update law such as~\cref{eq:chap-4-update-law} that requires feedback data $\mathbf{y}^{[n]}$ from the physical system, the mechanics-based method can obtain the input-output Jacobian by simulating changes in system outputs in response to small changes in inputs at each time step. Using finite difference methods, such as the central difference method, the Jacobian can be obtained numerically:
\begin{equation}
  \mathbf{J}_{ij}^{[n]} = \frac{\mathbf{f}_i^{[n]}(\mathbf{x}_j^{[n]} + \epsilon) - \mathbf{f}_i^{[n]}(\mathbf{x}_j^{[n]} - \epsilon)}{2\epsilon},\label{eq:chap-4-central-difference}
\end{equation}
where we use the indicial notation to denote element index. Indices $i \in M$ and $j \in N$, and constant $\epsilon$ is a small number. The input-output relation in terms of their variation can be written as
\begin{equation}
\delta \mathbf{y} = \mathbf{J}(\mathbf{x})\delta \mathbf{x}.\label{eq:chap-4-variation}
\end{equation}
Although not strictly necessary, we focus our attention on the present case with $M = N = 3$, \textit{i.e.} $\mathbf{J}$ is a square matrix.

\subsection{Parameter Tuning with Prostate Phantom}
\label{sec:parameter_tuning}
Since the comparative study between two controllers is carried out in simulation, it is important that the identified simulator parameters be representative of a real physical object. For our study, we utilize a patient-specific prostate phantom. As shown in~\cref{fig:chap-4-phantom}, the phantom consists of a prostate, urethra, seminal vesicles, and rectum, submerged in a volume of surrounding soft tissue. Additional layers of muscle, fat, and skin are added to the rectal side of the phantom. All organs are created using 3D printed negative molds filled with hydrogels. Different organs have varied hydrogel contents composition to match tensile strength properties obtained from cadaveric samples. The molds are obtained from expert-segmented anonymized MRI scans of a male patient. A total of 6 clinical experts have evaluated the phantom, and testified to its realism as a training tool for prostate biopsies. 

Tissue parameters $\alpha$ and $\mu$, as well as contact point offset $b$ (see~\cref{fig:chap-4-schematic}), are obtained through iterative insertion simulation until the final resulting needle shape matches data collected on the physical phantom. Tuned parameters as well as average layer thickness, denoted by $\Delta\Omega$, for each phantom tissue layer are reported in~\cref{tab:chap-4-prostate-params} and are used in the simulator to represent the prostate phantom. The contact point offset $b$ was identified to be $-0.3$. Note that these values are representative of the phenomenological behavior of the needle in simulation rather than actual physical properties of tissue materials. Different sets of values can recreate similar needle behavior, but this aspect is not the focus of this manuscript.

\begin{table}[h]
\label{tab:chap-4-prostate-params}
\centering
\caption{Tuned model parameters and average layer thicknesses.}
\resizebox{\columnwidth}{!}{%
\begin{tabular}{|cc|cc|cc|cc|cc|}
\hline
\multicolumn{2}{|c|}{\textbf{Skin}} & \multicolumn{2}{c|}{\textbf{Fat}} & \multicolumn{2}{c|}{\textbf{Muscle}} & \multicolumn{2}{c|}{\textbf{Soft Tissue}} & \multicolumn{2}{c|}{\textbf{Prostate}} \\ \hline
\multicolumn{1}{|c|}{$\mu$} & $\alpha$ & \multicolumn{1}{c|}{$\mu$} & $\alpha$ & \multicolumn{1}{c|}{$\mu$} & $\alpha$ & \multicolumn{1}{c|}{$\mu$} & $\alpha$ & \multicolumn{1}{c|}{$\mu$} & $\alpha$ \\ \hline
\multicolumn{1}{|c|}{2e2MPa} & 1 & \multicolumn{1}{c|}{1.5e1MPa} & -1 & \multicolumn{1}{c|}{3e1MPa} & -1 & \multicolumn{1}{c|}{8e2MPa} & -1 & \multicolumn{1}{c|}{3.2e3MPa} & 1 \\ \hline
\multicolumn{2}{|c|}{$\Delta\Omega$: 2mm} & \multicolumn{2}{c|}{$\Delta\Omega$: 3mm} & \multicolumn{2}{c|}{$\Delta\Omega$: 5mm} & \multicolumn{2}{c|}{$\Delta\Omega$: 10.5mm} & \multicolumn{2}{c|}{$\Delta\Omega$: 55mm} \\ \hline
\end{tabular}%
}
\end{table}

\begin{figure}[h]
\begin{subfigure}{.68\columnwidth}
  \centering
  \includegraphics[width=1\columnwidth]{manuscripts/EMBC_2024/figures/prostate_phantom_cad.png}  
  \caption{}
  \label{fig:chap-4-sub-first}
\end{subfigure}
\begin{subfigure}{.28\columnwidth}
  \centering
  % include second image
  \includegraphics[width=1\columnwidth]{manuscripts/EMBC_2024/figures/prostate_target_cad.png}  
  \caption{}
  \label{fig:chap-4-sub-second} 
\end{subfigure}
\caption{(a) Prostate phantom with internal organs. (b) Selected 12-core biopsy target points in prostate phantom. Direction $z$ is flattened for current planar insertion scenario.}
\label{fig:chap-4-phantom}
\end{figure}

\subsection{Simulated Targeting Experiments}
\label{sec:chap-4-targeting-experiments}

Comparison between data-driven and mechanics-based needle controllers is carried out in the simulator. A total of 12 target points within the prostate phantom are selected (\cref{fig:chap-4-sub-second}), emulating a 12-core biopsy procedure. For each target, we compare the two controllers in both path-following and point-stabilization tasks, \textit{i.e.} retracing a desired needle tip path from entry to target, or reaching a target point without path guidance using only the start and end needle configurations.

The feasible paths for the needle tip are generated in the simulator through forward needle insertion (step \textcircled{1} in~\cref{fig:chap-4-schematic}). Upon reaching the target depth, the deflection of the needle tip is recorded and used as an initial offset at the entry point, such that by simply moving the needle in the $+x$-direction with zero initial slope, the needle tip reaches the selected target without $y$-axis adjustments.

According to~\parencite{kellyDirectMechanicalCharacterization2019}, cancerous and non-cancerous prostate tissues exhibit substantial differences in their elastic moduli. Most reported standard deviations fall approximately within $30-50\%$ of the mean elastic moduli for benign and cancerous prostate tissues (fig. 4 of~\parencite{kellyDirectMechanicalCharacterization2019}). In order to simulate scenarios when patient-specific tissue parameters differ from tuned parameter values, for mechanics-based controllers, we consider $\pm50\%$ parametric variation for each tissue layer based on~\cref{tab:chap-4-prostate-params}. Identical proportional gain $\mathbf{K_p} = \diag{[0.5, 1, 0.1]}$ are set for both controllers. The simulated needle is an $18$ gauge, $170$ mm-long solid bevel-tip needle. Needle template is positioned $22$ mm away from the skin.

Although needle tip slope $k_{tip}$ is used as an output, since the slope is less clinically relevant in assessing the surgical outcome, control execution stops when the final needle tip position error $err \leq 0.25$ mm from the target, where

\begin{equation}
  \label{eq:chap-4-error-mag}
  err = \sqrt{(x_{tip} - x_{goal})^2 + (y_{tip} - y_{goal})^2}.
\end{equation}

As a metric for controller performance evaluation, for each target and task, we calculate the percentage of maximum shape manipulation effort over final target depth:
\begin{align}
  \label{eq:chap-4-metric}
  P_{(\cdot)} = \frac{\max{\vert{\Delta y_{(\cdot)}}\vert}}{x_{target}} \times 100,
\end{align}
where subscript $(\cdot)$ denotes either needle base or needle template. Since for each target, $x_{target}$ is fixed, a smaller $P$ value indicates a smaller amount of adjustment for that specific controller and task.

\subsection{Controller Performance Comparison}
\label{sec:chap-4-controller-performance-comparison}
\begin{figure}[h]
  \centering
  \includegraphics[width=0.68\columnwidth]{manuscripts/EMBC_2024/figures/T9_traj.png}
  \caption{Needle tip and control input trajectories of path following task for Target 9. The $\pm 50\%$ represents parametric variations for the mechanics-based controller.}
  \label{fig:chap-4-T9-path}
\end{figure}

\subsubsection{Path Following}
\label{sec:chap-4-path-following}

In simulated experiments, both controllers are able to drive the needle tip to follow desired paths for all 12 targets without significant performance difference. We pick Target 9 as an illustrative example since it requires the longest insertion distance. As shown in~\cref{fig:chap-4-T9-path}, with $\pm 50\%$ parametric variation, the mechanics-based controller is able to keep up with its data-driven counterpart, as both controllers keep the needle tip relatively close to the given path from entry to target.

Comparing the mechanics-based controllers in~\cref{fig:chap-4-T9-path}, when the parameter values are increased by $50\%$, the controller perceives the tissues to be stiffer than they actually are. Therefore to generate the desired tip motion, larger manipulation efforts are needed, and vice versa. The sawtooth appearance of input signals can be attributed to the discretization of continuous needle paths.

\subsubsection{Point Stabilization}
\label{sec:chap-4-point-stabilization}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.68\columnwidth]{manuscripts/EMBC_2024/figures/T9_pt.png}
  \caption{Needle tip and control input trajectories of point stabilization task for Target 9. The $\pm 50\%$ represents parametric variations for the mechanics-based controller. Red brackets emphasize the needle's ``pivoting'' behavior due to excessive tissue compression.}
  \label{fig:chap-4-T9-pt}
\end{figure}

In simulated experiments, although both controllers can still reach all 12 target points, the difference between data-driven and mechanics-based controllers becomes evident when the path is removed and only entry and final target configurations are given.

Using Target 9 again as an example, shown in the top two graphs of~\cref{fig:chap-4-T9-pt}, when the needle is inserted to around $55$mm, an increasingly large template manipulation is returned by the data-driven controller as the needle tip starts to overshoot from the desired needle deflection. Since the bevel direction is in the $-y$-direction, the controller attempts to correct the error by moving the needle shaft in the $+y$-direction such that by compressing the tissue, the controller is able to bring the needle tip upward. This strategy works well initially because tissue compression is small, and so is the resistance force; yet as the tissue is further compressed, strain-hardening tissue response increases the reaction force on the needle shaft, and such strategy quickly becomes ineffective.

Since bending of the needle still reduces tip error, albeit in a diminishing manner, inversion of the Jacobian mapping generates increasingly large control signals, shown as the rising input signal on the top left figure. Such template motion generates a ``pivoting'' behavior as the needle tip starts to point further down in the bevel direction, which can only result in further deviation from desired target as the needle inserts. This period is highlighted by red brackets in~\cref{fig:chap-4-T9-pt}.

To prevent the data-driven controller from generating excessive tissue compression, we implement a thresholding strategy that scales down the signal to regulate control inputs, and as a way to let the controller better observe the needle behavior under small adjustment before computing the next input signals. This strategy successfully limits the magnitude of the control signa, and allows the controller to complete the task. Other techniques can also be implemented to regulate the data-driven control signals such that the commanded shape manipulation falls within a safety margin and hardware limit.

In comparison, the mechanics-based controller generates smoother signals due to the fact that the system Jacobian is simulated by small variations of input signals, as explained previously with~\cref{eq:chap-4-central-difference}.

\begin{table}[]
\caption{Summary of controller performance under two tasks, sorted in ascending order of target depth.}
\label{tab:chap-4-summary}
\resizebox{\textwidth}{!}{%
\begin{tabular}{cccc|cccccc|cccccc|}
\cline{5-16}
 &  &  &  & \multicolumn{6}{c|}{Path-Following $P$ {[}\%{]}} & \multicolumn{6}{c|}{Point-Stabilization $P$ {[}\%{]}} \\ \hline
\multicolumn{1}{|c|}{\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}}Target\\ Number\end{tabular}}} & \multicolumn{1}{c|}{\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}}Depth\\ {[}mm{]}\end{tabular}}} & \multicolumn{1}{c|}{\multirow{2}{*}{\begin{tabular}[c]{@{}c@{}}Deflection\\ {[}mm{]}\end{tabular}}} & \multirow{2}{*}{\begin{tabular}[c]{@{}c@{}}Slope\\ {[}\%{]}\end{tabular}} & \multicolumn{2}{c|}{Data-driven} & \multicolumn{2}{c|}{+50\% Mech} & \multicolumn{2}{c|}{-50\% Mech} & \multicolumn{2}{c|}{Data-driven} & \multicolumn{2}{c|}{+50\% Mech} & \multicolumn{2}{c|}{-50\% Mech} \\ \cline{5-16} 
\multicolumn{1}{|c|}{} & \multicolumn{1}{c|}{} & \multicolumn{1}{c|}{} &  & \multicolumn{1}{c|}{base} & \multicolumn{1}{c|}{template} & \multicolumn{1}{c|}{base} & \multicolumn{1}{c|}{template} & \multicolumn{1}{c|}{base} & template & \multicolumn{1}{c|}{base} & \multicolumn{1}{c|}{template} & \multicolumn{1}{c|}{base} & \multicolumn{1}{c|}{template} & \multicolumn{1}{c|}{base} & template \\ \hline
\multicolumn{1}{|c|}{1} & \multicolumn{1}{c|}{30.62} & \multicolumn{1}{c|}{-1.00} & -2.00 & \multicolumn{1}{c|}{3.74} & \multicolumn{1}{c|}{1.98} & \multicolumn{1}{c|}{3.74} & \multicolumn{1}{c|}{1.98} & \multicolumn{1}{c|}{2.38} & 1.48 & \multicolumn{1}{c|}{6.00} & \multicolumn{1}{c|}{2.82} & \multicolumn{1}{c|}{8.41} & \multicolumn{1}{c|}{3.36} & \multicolumn{1}{c|}{4.43} & 2.76 \\ \hline
\multicolumn{1}{|c|}{2} & \multicolumn{1}{c|}{33.02} & \multicolumn{1}{c|}{-1.21} & -2.00 & \multicolumn{1}{c|}{4.12} & \multicolumn{1}{c|}{2.31} & \multicolumn{1}{c|}{4.36} & \multicolumn{1}{c|}{2.35} & \multicolumn{1}{c|}{2.54} & 1.61 & \multicolumn{1}{c|}{7.01} & \multicolumn{1}{c|}{3.05} & \multicolumn{1}{c|}{9.19} & \multicolumn{1}{c|}{3.72} & \multicolumn{1}{c|}{5.23} & 3.05 \\ \hline
\multicolumn{1}{|c|}{3} & \multicolumn{1}{c|}{35.42} & \multicolumn{1}{c|}{-1.38} & -3.00 & \multicolumn{1}{c|}{3.49} & \multicolumn{1}{c|}{1.76} & \multicolumn{1}{c|}{3.69} & \multicolumn{1}{c|}{1.76} & \multicolumn{1}{c|}{2.04} & 1.09 & \multicolumn{1}{c|}{6.90} & \multicolumn{1}{c|}{1.79} & \multicolumn{1}{c|}{9.04} & \multicolumn{1}{c|}{2.50} & \multicolumn{1}{c|}{5.28} & 1.83 \\ \hline
\multicolumn{1}{|c|}{4} & \multicolumn{1}{c|}{40.22} & \multicolumn{1}{c|}{-1.80} & -3.00 & \multicolumn{1}{c|}{3.07} & \multicolumn{1}{c|}{1.69} & \multicolumn{1}{c|}{3.01} & \multicolumn{1}{c|}{1.58} & \multicolumn{1}{c|}{1.88} & 1.09 & \multicolumn{1}{c|}{8.87} & \multicolumn{1}{c|}{2.21} & \multicolumn{1}{c|}{10.77} & \multicolumn{1}{c|}{3.10} & \multicolumn{1}{c|}{7.76} & 2.28 \\ \hline
\multicolumn{1}{|c|}{12} & \multicolumn{1}{c|}{40.22} & \multicolumn{1}{c|}{-1.80} & -3.00 & \multicolumn{1}{c|}{3.68} & \multicolumn{1}{c|}{2.27} & \multicolumn{1}{c|}{3.35} & \multicolumn{1}{c|}{1.94} & \multicolumn{1}{c|}{2.22} & 1.45 & \multicolumn{1}{c|}{9.42} & \multicolumn{1}{c|}{3.07} & \multicolumn{1}{c|}{11.32} & \multicolumn{1}{c|}{4.06} & \multicolumn{1}{c|}{8.39} & 3.17 \\ \hline
\multicolumn{1}{|c|}{11} & \multicolumn{1}{c|}{45.02} & \multicolumn{1}{c|}{-2.23} & -4.00 & \multicolumn{1}{c|}{3.12} & \multicolumn{1}{c|}{2.12} & \multicolumn{1}{c|}{2.94} & \multicolumn{1}{c|}{1.76} & \multicolumn{1}{c|}{1.99} & 1.41 & \multicolumn{1}{c|}{11.03} & \multicolumn{1}{c|}{3.04} & \multicolumn{1}{c|}{13.03} & \multicolumn{1}{c|}{4.43} & \multicolumn{1}{c|}{10.91} & 3.33 \\ \hline
\multicolumn{1}{|c|}{5} & \multicolumn{1}{c|}{54.62} & \multicolumn{1}{c|}{-3.08} & -5.00 & \multicolumn{1}{c|}{2.36} & \multicolumn{1}{c|}{1.56} & \multicolumn{1}{c|}{2.20} & \multicolumn{1}{c|}{1.33} & \multicolumn{1}{c|}{1.38} & 1.12 & \multicolumn{1}{c|}{15.03} & \multicolumn{1}{c|}{3.81} & \multicolumn{1}{c|}{16.28} & \multicolumn{1}{c|}{4.66} & \multicolumn{1}{c|}{16.95} & 3.25 \\ \hline
\multicolumn{1}{|c|}{6} & \multicolumn{1}{c|}{54.62} & \multicolumn{1}{c|}{-3.08} & -5.00 & \multicolumn{1}{c|}{2.35} & \multicolumn{1}{c|}{1.63} & \multicolumn{1}{c|}{2.25} & \multicolumn{1}{c|}{1.35} & \multicolumn{1}{c|}{1.42} & 1.17 & \multicolumn{1}{c|}{14.73} & \multicolumn{1}{c|}{3.28} & \multicolumn{1}{c|}{16.27} & \multicolumn{1}{c|}{4.80} & \multicolumn{1}{c|}{16.92} & 3.39 \\ \hline
\multicolumn{1}{|c|}{10} & \multicolumn{1}{c|}{61.82} & \multicolumn{1}{c|}{-3.78} & -6.00 & \multicolumn{1}{c|}{2.28} & \multicolumn{1}{c|}{1.70} & \multicolumn{1}{c|}{2.31} & \multicolumn{1}{c|}{1.52} & \multicolumn{1}{c|}{1.57} & 1.37 & \multicolumn{1}{c|}{17.96} & \multicolumn{1}{c|}{5.17} & \multicolumn{1}{c|}{18.74} & \multicolumn{1}{c|}{6.49} & \multicolumn{1}{c|}{21.47} & 4.45 \\ \hline
\multicolumn{1}{|c|}{7} & \multicolumn{1}{c|}{64.22} & \multicolumn{1}{c|}{-4.07} & -6.00 & \multicolumn{1}{c|}{1.96} & \multicolumn{1}{c|}{1.33} & \multicolumn{1}{c|}{1.88} & \multicolumn{1}{c|}{1.14} & \multicolumn{1}{c|}{1.18} & 0.99 & \multicolumn{1}{c|}{25.04} & \multicolumn{1}{c|}{\textbf{29.69}} & \multicolumn{1}{c|}{19.87} & \multicolumn{1}{c|}{6.38} & \multicolumn{1}{c|}{23.51} & 4.08 \\ \hline
\multicolumn{1}{|c|}{8} & \multicolumn{1}{c|}{66.62} & \multicolumn{1}{c|}{-4.28} & -6.00 & \multicolumn{1}{c|}{1.92} & \multicolumn{1}{c|}{1.31} & \multicolumn{1}{c|}{1.84} & \multicolumn{1}{c|}{1.14} & \multicolumn{1}{c|}{1.16} & 0.98 & \multicolumn{1}{c|}{27.43} & \multicolumn{1}{c|}{\textbf{42.07}} & \multicolumn{1}{c|}{20.73} & \multicolumn{1}{c|}{6.78} & \multicolumn{1}{c|}{25.25} & 4.97 \\ \hline
\multicolumn{1}{|c|}{9} & \multicolumn{1}{c|}{69.02} & \multicolumn{1}{c|}{-4.55} & -6.00 & \multicolumn{1}{c|}{2.20} & \multicolumn{1}{c|}{1.52} & \multicolumn{1}{c|}{2.00} & \multicolumn{1}{c|}{1.32} & \multicolumn{1}{c|}{1.36} & 1.18 & \multicolumn{1}{c|}{20.76} & \multicolumn{1}{c|}{6.56} & \multicolumn{1}{c|}{21.29} & \multicolumn{1}{c|}{7.67} & \multicolumn{1}{c|}{26.12} & 6.15 \\ \hline
\end{tabular}%
}
\end{table}

\subsection{Task Performance Comparison}
\label{sec:task_performance_comparison}
It is insightful to use the performance metric $P$ from~\cref{eq:chap-4-metric} to further compare the two tasks. For path-following, the magnitude of shape manipulation is overall smaller compared to point-stabilization. More specifically, the performance metric values for path-following are below $5\%$ for all targets regardless of insertion depth; however, for point-stabilization, the $P$ values appear to increase with deeper targets, suggesting a larger magnitude of needle shape change needed for deeper insertions.

\begin{figure}[h]
  \centering
  \includegraphics[width=\columnwidth]{manuscripts/EMBC_2024/figures/final_shape_comparison.png}
  \caption{Target 9 needle shapes comparison against the desired needle shape. Data-driven controller is used for path following (\Cref{fig:chap-4-T9-path} top) and point stabilization (\Cref{fig:chap-4-T9-pt}).}
  \label{fig:chap-4-final-shape-comparison}
\end{figure}

This behavior can also be observed directly by comparing~\cref{fig:chap-4-T9-path} and~\ref{fig:chap-4-T9-pt}: to reach the same target, the shape change required to follow the path is on the magnitude of around 1mm, but can require ten times the effort to drive the needle when no path is provided. Under point-stabilization, two instances can be found in~\cref{tab:chap-4-summary} where the data-driven controller generates a maximum needle template displacement of over $20\%$ of the insertion depth, suggesting that over $20$ mm displacement is required near the entry point, which can lead to significant risk of tissue damage.

This is made clear in~\ref{fig:chap-4-final-shape-comparison} when comparing the final needle shapes for the two tasks to the desired needle shape, from which the needle path is generated. The needle shape after point stabilization (top graphs of~\cref{fig:chap-4-T9-pt}) deviates from the desired shape, particularly at the needle base where a large vertical displacement is generated and results in significant needle shape change; for path following (top graphs of~\cref{fig:chap-4-T9-path}), the resulting shape nearly overlaps with the desired shape.

The difference in performance metric $P$ for path-following and point-stabilization tasks highlights the importance of using a feasible needle path, particularly for numerical-Jacobian-based resolved-rate controllers for needle control. Since numerical Jacobians only capture the system behavior in a small neighborhood, presenting the controllers with intermediate goal points can relax the requirement of accurate system dynamics over a long time horizon. In the case of autonomous bevel-tip needle insertion under shape manipulation, this can mean the difference between a successful insertion and a irreversible damage to the soft tissue.

The two highlighted $P$ values for the data-driven controller can be mitigated by placing a heavier restriction on the input signals such that needle ``pivoting'' is avoided completely; however, our current goal is to demonstrate the controller behavior and suggest a possible solution, without heavily modify the controller to suit our particular need.

Note that in~\cref{eq:chap-4-metric}, $P$ is scaled by the depth of each target $x_{target}$. This choice is motivated by our intuition that smaller needle manipulations can lead to a safer operation. Other metrics can be used that take into account the rate of needle manipulation, as well as the depth at which maximum manipulation is applied. A more thorough investigation of rate-dependent soft tissue behaviors under large strain, such as tissue tearing, is needed to better motivate a performance metric that correlates more directly with patient safety. 


\section{Chapter Acknowledgment}
\label{sec:chap-4-ack}
This chapter is based on

\parencite{wangBevelTipNeedleDeflection2024}:  Wang, Y., Al-Zogbi, Lidia, Liu, G., Liu, J., Tokuda, J., Krieger, A., \& Iordachita, I. (2024). Bevel-Tip Needle Deflection Modeling, Simulation, and Validation in Multi-Layer Tissues. IEEE International Conference on Robotics and Automation, IEEE International Conference on Robotics and Automation, 2024.

\parencite{wangShapeManipulationBevelTip2024}: Wang, Y., Al-Zogbi, Lidia, Liu, J., Shepard, L., Ghazi, A., Tokuda, J., Leonard, S.,  (2024). Shape Manipulation of Bevel-Tip Needles for Prostate Biopsy Procedures: A Comparison of Two Resolved-Rate Controllers. In , 2024 46th Annual International Conference of the IEEE Engineering in Medicine and Biology Society (EMBC) (pp. 17).

I would like to thank Lidia Al-Zogbi for making the tissue phantoms, tuning the simulation parameters, as well as her help running the experiments.

%%% Local Variables:
%%% mode: LaTeX
%%% TeX-master: "main"
%%% End:
